---
# Frontend Role - Main Tasks
- name: Install Node.js 18.x
  shell: |
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    apt-get install -y nodejs

- name: Remove existing frontend directories
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /opt/frontend
    - /opt/frontend-repo

- name: Create frontend directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - /opt/frontend
    - /var/www/html

- name: Clone frontend repository
  git:
    repo: "{{ github_repo }}"
    dest: /opt/frontend-repo
    version: "{{ repo_branch }}"
    force: yes
    depth: 1

- name: Copy frontend source to build directory
  shell: |
    rm -rf /opt/frontend
    cp -r /opt/frontend-repo/frontend /opt/frontend
    chown -R root:root /opt/frontend

- name: Update API URLs in frontend services
  replace:
    path: "{{ item }}"
    regexp: 'https://employee-management-app-gdm5\.onrender\.com'
    replace: 'http://{{ ansible_host }}'
  loop:
    - /opt/frontend/src/services/employeeService.js
    - /opt/frontend/src/services/departmentService.js

- name: Install frontend dependencies
  shell: |
    cd /opt/frontend
    rm -rf node_modules package-lock.json
    npm cache clean --force
    npm install --legacy-peer-deps
  args:
    chdir: /opt/frontend
  environment:
    NODE_OPTIONS: "--max-old-space-size=2048"
  async: 600
  poll: 30

- name: Build React frontend
  shell: |
    cd /opt/frontend
    npm run build
  args:
    chdir: /opt/frontend
  environment:
    NODE_OPTIONS: "--max-old-space-size=2048"
    CI: "false"
    GENERATE_SOURCEMAP: "false"
  async: 900
  poll: 30

- name: Deploy built React app
  shell: |
    rm -rf /var/www/html/*
    cp -r /opt/frontend/build/* /var/www/html/
    chown -R www-data:www-data /var/www/html
    
- name: Verify frontend files exist
  stat:
    path: /var/www/html/index.html
  register: frontend_files

- name: Debug frontend deployment status
  debug:
    msg: "Frontend files deployed: {{ frontend_files.stat.exists }}"

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/npm-*
    - /opt/frontend/node_modules/.cache
  ignore_errors: yes